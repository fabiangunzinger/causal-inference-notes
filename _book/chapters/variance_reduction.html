<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.353">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Online experiments - 14&nbsp; Variance reduction</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../chapters/network_experiments.html" rel="next">
<link href="../chapters/practical_issues.html" rel="prev">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>
</head><body class="nav-sidebar floating"><span class="math inline">
    \(

    \usepackage{mathtools}
    \newcommand{\nc}{\newcommand}

    %%%%%%%%%%%%%%%%
    % sample sizes %
    %%%%%%%%%%%%%%%%

    \nc{\N}{N}
    \nc{\Nt}{\N_t}
    \nc{\Nc}{\N_c}
    
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    % sampling and treatment assignment %
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

    \nc{\ti}{W}                       % treatment indicator
    \nc{\tii}{\ti_i}                  % treatment indicator for unit i

    %%%%%%%%%%%%
    % outcomes %
    %%%%%%%%%%%%

    \nc{\y}{Y}

    \nc{\ypt}{\y_i(1)}
    \nc{\ypc}{\y_i(0)}
    \nc{\yptb}{\bar{\y}(1)}
    \nc{\ypcb}{\bar{\y}(0)}
    
    \nc{\yo}{\y^{obs}}
    \nc{\yoi}{\y_i^{obs}}
    \nc{\yotb}{\bar{\y}_t^{obs}}
    \nc{\yocb}{\bar{\y}_c^{obs}}
    
    \nc{\yotbf}{\frac{1}{\Nt}\sum_{i:\tii=1} \yoi}
    \nc{\yocbf}{\frac{1}{\Nc}\sum_{i:\tii=0} \yoi}

    %%%%%%%%%%%%%%%%%%%%
    % sums of outcomes %
    %%%%%%%%%%%%%%%%%%%%

    %%%%%%%%%%%%%%%%%%%%%
    % treatment effects %
    %%%%%%%%%%%%%%%%%%%%%

    \nc{\te}{\tau}
    \nc{\tee}{\hat{\te}}   
    \nc{\tef}{\yptb - \ypcb}
    \nc{\teef}{\yotb - \yocb}
    \nc{\tefs}{\frac{1}{\N}\sum_{i=1}^N\left(\ypt-\ypc\right)}

    
    %%%%%%%%%%%%%%%%%%%%
    % sample variances %
    %%%%%%%%%%%%%%%%%%%%

    \nc{\spv}{\sigma}   %symbol pop var
    \nc{\sev}{\hat{\sigma}}   %symbol estimated var

    \nc{\vt}{\spv^2_t}
    \nc{\vc}{\spv^2_c}
    \nc{\vp}{\spv^2}
    \nc{\vte}{\sev^2_t}
    \nc{\vce}{\sev^2_c}
    \nc{\vpe}{\sev^2}
    \nc{\vtf}{\frac{1}{\N-1}\sum_{i=1}^{N}(\ytp - \yptb)^2}
    \nc{\vcf}{\frac{1}{\N-1}\sum_{i=1}^{N}(\ycp - \ypcb)^2}
    \nc{\vtef}{\frac{1}{\Nt-1}\sum_{i:W_i=t}\left(\yoi - \yotb\right)^2}
    \nc{\vcef}{\frac{1}{\Nc-1}\sum_{i:W_i=c}\left(\yoi - \yocb\right)^2}
    \nc{\vpef}{\frac{(\Nt - 1)\vte + (\Nc - 1)\vce}{\Nt + \Nc - 2}}

    %%%%%%%%%%%%%%%%%%%%%%
    % sampling variances %
    %%%%%%%%%%%%%%%%%%%%%%

    % sv[Estimate][Formula][Equal/Unequal][with treat Proportion]

    \nc{\sv}{V\left(\tee\right)}
    \nc{\sve}{\hat{V}(\tee)}

    \nc{\svfe}{\vp\left(\frac{1}{\Nt} + \frac{1}{\Nc}\right)}
    \nc{\svfu}{\frac{\vt}{\Nt} + \frac{\vc}{\Nc}}
    \nc{\svefe}{\vpe\left(\frac{1}{\Nt} + \frac{1}{\Nc}\right)}
    \nc{\svefu}{\frac{\vte}{\Nt} + \frac{\vce}{\Nc}}

    \nc{\svefep}{\vpe\left(\frac{1}{P(1-P)\N\right)}}


    %%%%%%%%%%%%%%%%%%%
    % standard errors %
    %%%%%%%%%%%%%%%%%%%

    % naming convention as for variance but with se prefix

    \nc{\se}{\text{se}(\tee)}
    \nc{\sefu}{\sqrt{\svfu}}
    \nc{\sefe}{\sqrt{\svfe}}
    \nc{\sefep}{\sqrt{\frac{\vpe}{P(1-P)N}}}


    %%%%%%%%%%%%%%%%%%%%%%
    % hypothesis testing %
    %%%%%%%%%%%%%%%%%%%%%%

    \nc{\hn}{H_0}
    \nc{\ha}{H_A}
    \nc{\za}{z_\stoe}
    \nc{\zb}{z_{1 - \stte}}


    %%%%%%%%%%%%%%
    % misc. math %
    %%%%%%%%%%%%%%

    \nc{vs}{\\[5pt]}                       % math mode extra vertical space


    \nc{E}[1]{\mathbb{E}\left[#1\right]}    % expectation operator
    \nc{lb}[1]{\left[#1\right]}             % large brackets
    \nc{lp}[1]{\left(#1\right)}             % large parenthesis

    \nc{sot}{\sum_{i:W_i=t}}                % sum over treatment units
    \nc{soc}{\sum_{i:W_i=t}}                % sum over control units



    \nc{\stoe}{\alpha}                % type one error
    \nc{\stte}{\beta}                 % type two error


    %%%%%%%%%%%%%%%%%%
    % other commands %
    %%%%%%%%%%%%%%%%%%

    \nc{\mc}[1]{\text{\scriptsize(#1)}} %math inline comment

    <!-- These aren't working for some reason -->
    <!-- \nc{\lp}{\left(} -->
    <!-- \nc{\rp}{\right)} -->
    <!-- \nc{\lb}{\left[} -->
    <!-- \nc{\rb}{\right]} -->

    \)
</span>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>





<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../chapters/ethics.html">Practical issues</a></li><li class="breadcrumb-item"><a href="../chapters/variance_reduction.html"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Variance reduction</span></a></li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="../">Online experiments</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">index.html</span></span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
 <span class="menu-text">Introduction</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/introduction.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Introduction</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../chapters/statistics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Statistics</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/treatment_assignment.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Sampling and assignment</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/outcomes.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Outcomes</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/standard_error.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Standard error</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/testing_and_cis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Testing and confidence intervals</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/power.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Power</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/analysis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Analysis</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">
 <span class="menu-text">Practical issues</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/ethics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Ethics</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/experiment_design.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Experiment design</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/metrics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Metrics</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/threats_to_validity.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Threats to validity</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/practical_issues.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Practical issues</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/variance_reduction.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Variance reduction</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/network_experiments.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Network experiments</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true">
 <span class="menu-text">Appendices</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/stats_foundations.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Statistics foundation</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/projection.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">Projection</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/fwl.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title">FWL</span></span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#why-reduce-variance" id="toc-why-reduce-variance" class="nav-link active" data-scroll-target="#why-reduce-variance"><span class="header-section-number">14.1</span> Why reduce variance?</a></li>
  <li><a href="#cuped" id="toc-cuped" class="nav-link" data-scroll-target="#cuped"><span class="header-section-number">14.2</span> CUPED</a>
  <ul class="collapse">
  <li><a href="#how-does-cuped-work" id="toc-how-does-cuped-work" class="nav-link" data-scroll-target="#how-does-cuped-work"><span class="header-section-number">14.2.1</span> How does CUPED work</a></li>
  <li><a href="#how-does-cuped-work-1" id="toc-how-does-cuped-work-1" class="nav-link" data-scroll-target="#how-does-cuped-work-1"><span class="header-section-number">14.2.2</span> How does CUPED work?</a></li>
  <li><a href="#what-does-effect-of-cuped-depend-on" id="toc-what-does-effect-of-cuped-depend-on" class="nav-link" data-scroll-target="#what-does-effect-of-cuped-depend-on"><span class="header-section-number">14.2.3</span> What does effect of CUPED depend on?</a></li>
  <li><a href="#features" id="toc-features" class="nav-link" data-scroll-target="#features"><span class="header-section-number">14.2.4</span> Features</a></li>
  <li><a href="#questions" id="toc-questions" class="nav-link" data-scroll-target="#questions"><span class="header-section-number">14.2.5</span> Questions</a></li>
  <li><a href="#implementation-challenges" id="toc-implementation-challenges" class="nav-link" data-scroll-target="#implementation-challenges"><span class="header-section-number">14.2.6</span> Implementation challenges</a></li>
  <li><a href="#is-cuped-regression-adjustment" id="toc-is-cuped-regression-adjustment" class="nav-link" data-scroll-target="#is-cuped-regression-adjustment"><span class="header-section-number">14.2.7</span> Is CUPED regression adjustment?</a></li>
  <li><a href="#is-cuped-did" id="toc-is-cuped-did" class="nav-link" data-scroll-target="#is-cuped-did"><span class="header-section-number">14.2.8</span> Is CUPED DiD?</a></li>
  <li><a href="#non-linear-extensions" id="toc-non-linear-extensions" class="nav-link" data-scroll-target="#non-linear-extensions"><span class="header-section-number">14.2.9</span> Non-linear extensions</a></li>
  <li><a href="#blog-post-notes" id="toc-blog-post-notes" class="nav-link" data-scroll-target="#blog-post-notes"><span class="header-section-number">14.2.10</span> Blog post notes</a></li>
  </ul></li>
  <li><a href="#stratification" id="toc-stratification" class="nav-link" data-scroll-target="#stratification"><span class="header-section-number">14.3</span> Stratification</a>
  <ul class="collapse">
  <li><a href="#useful-resources" id="toc-useful-resources" class="nav-link" data-scroll-target="#useful-resources"><span class="header-section-number">14.3.1</span> Useful resources</a></li>
  </ul></li>
  <li><a href="#regression-adjustment" id="toc-regression-adjustment" class="nav-link" data-scroll-target="#regression-adjustment"><span class="header-section-number">14.4</span> Regression adjustment</a>
  <ul class="collapse">
  <li><a href="#useful-resources-1" id="toc-useful-resources-1" class="nav-link" data-scroll-target="#useful-resources-1"><span class="header-section-number">14.4.1</span> Useful resources</a></li>
  </ul></li>
  <li><a href="#cupac" id="toc-cupac" class="nav-link" data-scroll-target="#cupac"><span class="header-section-number">14.5</span> CUPAC</a>
  <ul class="collapse">
  <li><a href="#advantages" id="toc-advantages" class="nav-link" data-scroll-target="#advantages"><span class="header-section-number">14.5.1</span> Advantages</a></li>
  <li><a href="#thoughts" id="toc-thoughts" class="nav-link" data-scroll-target="#thoughts"><span class="header-section-number">14.5.2</span> Thoughts</a></li>
  <li><a href="#useful-resources-2" id="toc-useful-resources-2" class="nav-link" data-scroll-target="#useful-resources-2"><span class="header-section-number">14.5.3</span> Useful resources</a></li>
  </ul></li>
  <li><a href="#other-methods" id="toc-other-methods" class="nav-link" data-scroll-target="#other-methods"><span class="header-section-number">14.6</span> Other methods</a></li>
  <li><a href="#useful-resources-3" id="toc-useful-resources-3" class="nav-link" data-scroll-target="#useful-resources-3"><span class="header-section-number">14.7</span> Useful resources</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Variance reduction</span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<section id="why-reduce-variance" class="level2" data-number="14.1">
<h2 data-number="14.1" class="anchored" data-anchor-id="why-reduce-variance"><span class="header-section-number">14.1</span> Why reduce variance?</h2>
<p>We have seen in chapter <a href="power.html"><span>Chapter&nbsp;7</span></a> that if we want to control our Type I and Type II error rate, the required total sample size for our experiment is given by:</p>
<p><span class="math display">\[
N = \frac{(\zb + \za)^2}{P(1-P)}\frac{\vpe}{\te^2}.
\]</span></p>
<p>However, in a typical experiment, all elements but the outcome metric variance, <span class="math inline">\(\vpe\)</span>, are usually pre-determined:</p>
<ul>
<li><p><span class="math inline">\(\za\)</span> and <span class="math inline">\(\zb\)</span> by the significance level and the level of power we need,</p></li>
<li><p><span class="math inline">\(P\)</span> by how we choose to allocate traffic between variants (for two variants, it usually equalls 0.5),</p></li>
<li><p>and the absolute minimum detectable effect, <span class="math inline">\(\te\)</span>, ideally by business rationale.</p></li>
</ul>
<p>This makes reducing variance one of the main levers we have to reduce required sample size and thus increase experiemnt speed, which is the reason why it is such a key topic in the online experimentation literature.</p>
</section>
<section id="cuped" class="level2" data-number="14.2">
<h2 data-number="14.2" class="anchored" data-anchor-id="cuped"><span class="header-section-number">14.2</span> CUPED</h2>
<p>CUPED stands for “<strong>C</strong>ontrolled experiments <strong>U</strong>sing <strong>P</strong>re-<strong>E</strong>xperiment <strong>D</strong>ata”. It uses data from the pre-experiment period to partial out the time-invariant component of the outcome metric variance, thus reducing total variance.</p>
<p>Introduced by <span class="citation" data-cites="deng2013improving">(<a href="#ref-deng2013improving" role="doc-biblioref"><strong>deng2013improving?</strong></a>)</span>, it has since become an industry standard and is used by companies such as Booking.com, Netflix, and Meta, as well as commercial experimentation platforms such as Eppo and Statsig.</p>
<section id="how-does-cuped-work" class="level3" data-number="14.2.1">
<h3 data-number="14.2.1" class="anchored" data-anchor-id="how-does-cuped-work"><span class="header-section-number">14.2.1</span> How does CUPED work</h3>
<p>The key insight of CUPED is that, given the right data, it is possible to transform the raw outcome metric in a way that leaves the treatment effect estimator (<span class="math inline">\(\tee\)</span>) unbiased while reducing its variance.</p>
<p><strong>CUPED estimator</strong></p>
<p>Assume that, in addition to our outcome variable <span class="math inline">\(\yoi\)</span>, we have access to another random variable, <span class="math inline">\(X_i\)</span> with known expectation <span class="math inline">\(\mathbb{E}[X_i]\)</span>.</p>
<p>We can then define adjusted outcomes for all treatment and control units as</p>
<p><span class="math display">\[
\y^{cuped}_i = \yoi - \theta X_i + \theta\mathbb{E}[X_i].
\]</span></p>
<p>Calculating the average outcome for the treatment group, we get</p>
<p><span class="math display">\[
\begin{align}
\bar{\y}^{cuped}_t &amp;= \frac{1}{\Nt}\sot Y^{cuped}_i \vs
&amp;= \frac{1}{\Nt}\sot\lp{\yoi - \theta X_i + \theta\mathbb{E}[X_i]} \vs
&amp;= \bar{Y}^{obs}_t - \theta \bar{X}_t + \theta\E{X_i | \tii = 1}.
\end{align}
\]</span></p>
<p>Similarly, for the control group, we have</p>
<p><span class="math display">\[
\bar{\y}^{cuped}_c = \bar{Y}^{obs}_c - \theta \bar{X}_c + \theta\E{X_i | \tii = 0}.
\]</span></p>
<p>Our treatment effect estimator is now</p>
<p><span class="math display">\[
\begin{align}
\hat{\tau}^{cuped} &amp;= \lp{\bar{\y}^{cuped}_t - \bar{\y}^{cuped}_c} \vs
&amp;= \lp{\bar{Y}^{obs}_t - \theta \bar{X}_t + \theta\E{X_i | \tii = 1}} - \lp{\bar{Y}^{obs}_c - \theta \bar{X}_c + \theta\E{X_i | \tii = 0}}
\end{align}
\]</span></p>
<p><strong>Unbiasedness of CUPED estimator</strong></p>
<p>The CUPED estimator is unbiased because</p>
<p><span class="math display">\[
\begin{align}
\E{\hat{\tau}^{cuped}}
&amp;= \E{\lp{\bar{Y}^{obs}_t - \theta \bar{X}_t + \theta\E{X_i | \tii = 1}} - \lp{\bar{Y}^{obs}_c - \theta \bar{X}_c + \theta\E{X_i | \tii = 0}}} \vs
&amp;= \E{\bar{Y}^{obs}_t - \theta \bar{X}_t + \theta\E{X_i | \tii = 1}} - \E{\bar{Y}^{obs}_c - \theta \bar{X}_c + \theta\E{X_i | \tii = 0}} \vs
&amp;= \lp{\E{\bar{Y}^{obs}_t} - \theta \E{\bar{X}_t} + \theta\E{X_i | \tii = 1}} - \lp{\E{\bar{Y}^{obs}_c} - \theta \E{\bar{X}_c} + \theta\E{X_i | \tii = 0}} \vs
&amp;= \E{\bar{Y}^{obs}_t} - \E{\bar{Y}^{obs}_c} \vs
&amp;= \E{\tee},
\end{align}
\]</span></p>
<p>which we know is unbiased from <a href="outcomes.html"><span>Chapter&nbsp;4</span></a>.</p>
<p>** CUPED estimator variance**</p>
<p>If we do this for all units in our experiment, we will get gpl <span class="math display">\[
\yt
\]</span></p>
<ul>
<li><p>We can then define <span class="math inline">\(\bar{Y}^{cuped} = \bar{Y} - \theta \bar{X} + \theta \mathbb{E}X\)</span> for both treatment and control groups, and compare avearge outcomes in this adjusted metric.</p></li>
<li><p>Our new estimator is: <span class="math inline">\(\hat{\tau}^{cuped} = \bar{Y}^{cuped}_t - \bar{Y}^{cuped}_c\)</span>.</p></li>
<li><p><span class="math inline">\(\hat{\tau}^{cuped}\)</span> is unbiased since <span class="math inline">\(\mathbb{E}\left[\hat{\tau}^{cuped}\right] = \bar{Y}_t - \bar{Y}_c = \tau\)</span> (proof in appendix below).</p></li>
<li><p>If treatment effects are small (which, in practice, they usually are) and for an optimal choice of <span class="math inline">\(\theta\)</span>: <span class="math inline">\(\mathbb{V}\left(\hat{\tau}^{cuped}\right) \simeq \left(\frac{s_t}{N_t} + \frac{s_c}{N_c}\right)\left(1 - \rho^2\right)\)</span>, where <span class="math inline">\(\rho\)</span> is the correlation coefficient of <span class="math inline">\(Y\)</span> and <span class="math inline">\(X\)</span>.</p></li>
<li><p>Hence: <span class="math inline">\(\frac{\mathbb{V}(\hat{\tau}^{cuped})}{\mathbb{V}(\hat{\tau}^{dif})} = 1 - \rho^2\)</span> – the higher the correlation between <span class="math inline">\(Y\)</span> and <span class="math inline">\(X\)</span>, the more CUPED reduces the variance of our treatment estimate.</p></li>
</ul>
<p><span class="math display">\[
Y_i^{cuped} = Y_i - \frac{Cov(Y, X)}{Var(X)} X_i
\]</span></p>
</section>
<section id="how-does-cuped-work-1" class="level3" data-number="14.2.2">
<h3 data-number="14.2.2" class="anchored" data-anchor-id="how-does-cuped-work-1"><span class="header-section-number">14.2.2</span> How does CUPED work?</h3>
<p>CUPED supposes that in addition to an outcome metric <span class="math inline">\(y\)</span>, we also have access to another variable, <span class="math inline">\(x\)</span>, which is correlated with <span class="math inline">\(y\)</span> but uncorrelated with the treatment assignment of our experiment. Pre-experiment data of the outcome metric is a good candidate for <span class="math inline">\(x\)</span> when it is available – it’s what’s commonly used, and where the method gets its name from. With that in hand, notice that we can write</p>
<p>– the most obvious candidate that has been found to work well is pre-experiment data of the metric of interest.</p>
<p>We can then create a new variable</p>
<p><span class="math display">\[
\tilde{y} = y - \theta x,
\]</span></p>
<p>where – it turns out – the optimal choice for <span class="math inline">\(\theta\)</span> is <span class="math inline">\(\frac{cov(y, x)}{var(x)}\)</span>, which we can easily calculate from the available data.</p>
<p>This is useful because it can be shown that if we now evaluate our experiment using <span class="math inline">\(\tilde{y}\)</span> instead of <span class="math inline">\(y\)</span>, the treatment estimate will be the same but it’s standard error will be lower, which will increase power. The standard error of the treatment effect estimate is lower because the variance of <span class="math inline">\(\tilde{y}\)</span> is lower than that of <span class="math inline">\(y\)</span> whenever <span class="math inline">\(cov(y, x) \neq 0\)</span>, that is, whenever <span class="math inline">\(x\)</span> and <span class="math inline">\(y\)</span> are indeed correlated. To be precise, we have:</p>
<p><span class="math display">\[
var(\tilde{y}) = var(y)(1 - \rho^2),
\]</span></p>
<p>where <span class="math inline">\(\rho\)</span> is the Pearson correlation between <span class="math inline">\(x\)</span> and <span class="math inline">\(y\)</span>:</p>
<p><span class="math display">\[
\rho = \frac{cov(y, x)}{var(x)var(y)}.
\]</span></p>
<p>Presentation notes:</p>
<p><span class="math inline">\(\hat{\tau}^{cuped}\)</span> is unbiased:</p>
<p><span class="math display">\[
\begin{align*}
\mathbb{E}\left[\hat{\tau}^{cuped}\right] &amp;= \mathbb{E}\left[\bar{Y}^{cuped}_t - \bar{Y}^{cuped}_c\right] \\
&amp;= \mathbb{E}\left[\left(\bar{Y}_t - \theta \bar{X}_t + \theta \mathbb{E}X\right) - \left(\bar{Y}_c - \theta \bar{X}_c + \theta \mathbb{E}X\right)\right] \\
&amp;= \mathbb{E}\left[\left(\bar{Y}_t - \theta \bar{X}_t\right) - \left(\bar{Y}_c - \theta \bar{X}_c\right)\right] \\
&amp;= \mathbb{E}\left[\bar{Y}_t - \bar{Y}_c\right] \\
&amp;= \mathbb{E}\left[\frac{1}{N_t}\sum_{\text{i:T=1}}Y_i- \frac{1}{N_c}\sum_{\text{i:T=0}}Y_i\right] \\
&amp;= \frac{1}{N_t} N_t \mathbb{E}Y_t - \frac{1}{N_c} N_c \mathbb{E}Y_c \\
&amp;= \mathbb{E}Y_t - \mathbb{E}Y_c \\
&amp;= \bar{Y}_t - \bar{Y}_c \\
&amp;= \tau
\end{align*}
\]</span></p>
<p><span class="math inline">\(\hat{\tau}^{cuped}\)</span> has variance:</p>
<p><span class="math display">\[
\begin{align*}
\mathbb{V}\left(\hat{\tau}^{cuped}\right) &amp;= \mathbb{V}\left(\bar{Y}^{cuped}_t - \bar{Y}^{cuped}_c\right) \\
&amp;= \mathbb{V}\left(\bar{Y}^{cuped}_t\right) + \mathbb{V}\left(\bar{Y}^{cuped}_c\right) \\
&amp;= \mathbb{V}\left(\bar{Y}_t - \theta \bar{X}_t + \theta \mathbb{E}X\right) + \mathbb{V}\left(\bar{Y}_c - \theta \bar{X}_c + \theta
\mathbb{E}X\right) \\
&amp;= \mathbb{V}\left(\bar{Y}_t - \theta \bar{X}_t\right) + \mathbb{V}\left(\bar{Y}_c - \theta \bar{X}_c\right) \\
&amp;= \frac{1}{N_t}\mathbb{V}\left(Y_t - \theta X_t\right) + \frac{1}{N_c}\mathbb{V}\left(Y_c - \theta X_c\right) \\
&amp;= \frac{1}{N_t}\left[\mathbb{V}(Y_t) + \theta^2 \mathbb{V}(X_t) - 2\theta Cov(Y_t, X_t)\right] + \frac{1}{N_c}\left[\mathbb{V}(Y_c) + \theta^2 \mathbb{V}(X_c) - 2\theta Cov(Y_c, X_c)\right]
\end{align*}
\]</span></p>
<p>This is minimised for:</p>
<p><span class="math display">\[
\theta^* = \frac{Cov(Y_t, X_t) + Cov(Y_c, X_c)}{\mathbb{V}(X_t) + \mathbb{V}(X_c)}
\]</span></p>
<p>In practice, a common approach is to pool the data to get:</p>
<p><span class="math display">\[
\begin{align*}
\theta^*_p &amp;= \frac{Cov(Y, X) + Cov(Y, X)}{\mathbb{V}(X) + \mathbb{V}(X)}\\
&amp;= \frac{Cov(Y, X)}{\mathbb{V}(X)},
\end{align*}
\]</span></p>
<p>and to assume that <span class="math inline">\(\mathbb{V}(X_t) \simeq \mathbb{V}(X_t)\)</span>, and <span class="math inline">\(Cov(Y_t, X_t) \simeq Cov(Y_c, X_c)\)</span>, which is reasonable as long as the treatment effect is not too large (see discussion towards the end <a href="https://alexdeng.github.io/causal/sensitivity.html#vrreg">here</a>). If, in addition, we let <span class="math inline">\(\rho = Cor(X, Y)\)</span>, then we have</p>
<p><span class="math display">\[
\begin{align*}
\mathbb{V}\left(\hat{\tau}^{cuped}\right) &amp;\simeq \frac{1}{N_t}\left[\mathbb{V}(Y_t) + (\theta^*_p)^2 \mathbb{V}(X) - 2 \theta^*_p Cov(Y, X)\right] + \frac{1}{N_c}\left[\mathbb{V}(Y_c) + (\theta^*_p)^2 \mathbb{V}(X) - 2 \theta^*_p Cov(Y, X)\right]\\
&amp;= \frac{1}{N_t}\left[\mathbb{V}(Y_t) + \left(\frac{Cov(Y, X)}{\mathbb{V}(X)}\right)^2 \mathbb{V}(X) - 2 \left(\frac{Cov(Y, X)}{\mathbb{V}(X)}\right) Cov(Y, X)\right] + \frac{1}{N_c}\left[\mathbb{V}(Y_c) + \left(\frac{Cov(Y, X)}{\mathbb{V}(X)}\right)^2 \mathbb{V}(X) - 2 \left(\frac{Cov(Y, X)}{\mathbb{V}(X)}\right) Cov(Y, X)\right]\\
&amp;= \frac{1}{N_t}\left[\mathbb{V}(Y_t) - \frac{Cov(Y, X)^2}{\mathbb{V}(X)}\right] + \frac{1}{N_c}\left[\mathbb{V}(Y_c) - \frac{Cov(Y, X)^2}{\mathbb{V}(X)}\right]\\
&amp;= \frac{1}{N_t}\left[\mathbb{V}(Y_t) - \frac{\left(\rho\sqrt{\mathbb{V}(X)}\sqrt{\mathbb{V}(Y)}\right)^2}{\mathbb{V}(X)}\right] + \frac{1}{N_c}\left[\mathbb{V}(Y_c) - \frac{\left(\rho\sqrt{\mathbb{V}(X)}\sqrt{\mathbb{V}(Y)}\right)^2}{\mathbb{V}(X)}\right]\\
&amp;= \frac{1}{N_t}\left[\mathbb{V}(Y_t) - \rho^2\mathbb{V}(Y)\right] + \frac{1}{N_c}\left[\mathbb{V}(Y_c) - \rho^2\mathbb{V}(Y)\right]\\
&amp;= \frac{\mathbb{V}(Y_t)}{N_t}(1 - \rho^2) + \frac{\mathbb{V}(Y_c)}{N_c}(1 - \rho^2)\\
&amp;= \left[\frac{\mathbb{V}(Y_t)}{N_t} + \frac{\mathbb{V}(Y_c)}{N_c}\right]\left(1 - \rho^2\right)
\end{align*}
\]</span></p>
<p>In practice, we use the sample variances <span class="math inline">\(s_t = \frac{1}{N_t - 1}\sum_{\text{i:T=1}}\left(Y_i - \bar{Y}_t^{obs}\right)^2\)</span> and <span class="math inline">\(s_c = \frac{1}{N_c - 1}\sum_{\text{i:T=0}}\left(Y_i - \bar{Y}_c^{obs}\right)^2\)</span> as unbiased estimators for the variances of treatment and control outcomes, and a sample estimate of the correlation coefficient, <span class="math inline">\(\rho\)</span>.</p>
<p><strong>Things to notice</strong></p>
<ul>
<li><p>The main “trick” CUPED relies on for unbiasedness is the fact that we don’t actually have to know <span class="math inline">\(\mathbb{E}X\)</span> to obtain an unbiased estimator since it cancels out when we take the difference of two CUPED-adjusted variables.</p></li>
<li><p>Any fixed value of <span class="math inline">\(\theta\)</span> will give us an unbiased estimator of <span class="math inline">\(\tau\)</span>, so pooling the data and assuming equal variances and covariances in the treatment and control groups, as we did to calculate the variance, effect the degree of variance reduction only. If we didn’t make these assumptions, the factor by which CUPED reduces variance would be a more complicated term than <span class="math inline">\(\left(1 - \rho^2\right)\)</span>, involving separte variances and covariances from the treatment and control groups.</p></li>
</ul>
</section>
<section id="what-does-effect-of-cuped-depend-on" class="level3" data-number="14.2.3">
<h3 data-number="14.2.3" class="anchored" data-anchor-id="what-does-effect-of-cuped-depend-on"><span class="header-section-number">14.2.3</span> What does effect of CUPED depend on?</h3>
</section>
<section id="features" class="level3" data-number="14.2.4">
<h3 data-number="14.2.4" class="anchored" data-anchor-id="features"><span class="header-section-number">14.2.4</span> Features</h3>
<ul>
<li><p>Also permits non-linear adjustments (i.e.&nbsp;not reliant on linearity assumptions in OLS)</p></li>
<li><p>Reduces biase (see statsic post)</p></li>
</ul>
</section>
<section id="questions" class="level3" data-number="14.2.5">
<h3 data-number="14.2.5" class="anchored" data-anchor-id="questions"><span class="header-section-number">14.2.5</span> Questions</h3>
<p>Questions:</p>
<ul class="task-list">
<li><input type="checkbox">Why does fillna(y) not increase variance</li>
<li><input type="checkbox">What happens if pre and post perfectly correlated</li>
<li><input type="checkbox">How much do actual metric values change due to adjustment</li>
</ul>
</section>
<section id="implementation-challenges" class="level3" data-number="14.2.6">
<h3 data-number="14.2.6" class="anchored" data-anchor-id="implementation-challenges"><span class="header-section-number">14.2.6</span> Implementation challenges</h3>
</section>
<section id="is-cuped-regression-adjustment" class="level3" data-number="14.2.7">
<h3 data-number="14.2.7" class="anchored" data-anchor-id="is-cuped-regression-adjustment"><span class="header-section-number">14.2.7</span> Is CUPED regression adjustment?</h3>
<p>todo: - Incorporate Rice content on prediction and MSE (chapter 4.4 and ipad notes), which exactly gets us the CUPED result, again showing that CUPED is a re-invention of linear regression and standard stats</p>
<ul>
<li><p>Is CUPED regression adjustment? Identical to regression only in simple case (show FWL link – have separate post on understanding FWL with relevant regression examples)</p></li>
<li><p>Take inclusion of constant into accound (centering variables, but doesn’t change correlations)</p></li>
<li><p>Show that in multiple regression, var(Y_adjusted) = var(y_unadjusted)(1 - R^2) – so, CUPED result is just a specieal case where k = 1, in which case R^2 = rho.</p></li>
<li><p>I think it really is. CUPED can be extended to (make notation consistent with CUPED)</p></li>
</ul>
<p><span class="math display">\[
y' = y - \theta \bar{f(X)} + \theta E(f(X))
\]</span></p>
<ul>
<li><p>In above, it can be shown that optimal <span class="math inline">\(f(X) = E(Y|X)\)</span> (show this). CUPED uses best linear predictor. CUPAC extends this to non-linear predictors, generating <span class="math inline">\(\hat{y} = g(X) = E(Y|X)\)</span>. This is an example of using a non-linear function of X as Deng points out is possible. But if you do this, theta is still the OLS coefficient, so it’s still equivalent to just sticking g(X) into the regression as a covariate.</p></li>
<li><p>The motivation for CUPED seems to be a bit of a strawman: that regression adjustment relies on assumption that expectation of Y conditional on X is linear. Imbens and Rubin in 7.5 show that this is not required. Neither is homoskedasticity, or, rather, this should hold anyways given randomisation. Study chapter 7.</p></li>
<li><p>As pointed out in <span class="citation" data-cites="tang2000control">Tang et al. (<a href="#ref-tang2000control" role="doc-biblioref">2000</a>)</span>, the Deng argument that you don’t need linear assumptions in CUPED seems to be inspired by the Friedman critique of OLS for experiments.</p></li>
<li><p>So the CUPED motivation might not be a strawem as much as a result of the debate in statistics about whether you should use OLS for experiment analysis or not. This is probs the way I want to frame the entire issue – review debate (key point of Friedman critique, Lin’s repsonse, Imbens and Rubin’s take, and then discuss cuped and regression adjustment in that light). Basically, if you follow Lin, then cuped is just regression adjustment. If you follow Friedman, then you shouldn’t do regression adjustment and use cuped. But then do practical comparisons and show that you get the same results in practice, which seems to show that using linear regression clearly works.</p></li>
</ul>
<p>It turns out that in the simple cases discussed above, it doesn’t – the two approaches are identical! Seeing why requires a few steps.</p>
<p>First, we know (from the Frisch-Waugh-Lowell <a href="https://en.wikipedia.org/wiki/Frisch%E2%80%93Waugh%E2%80%93Lovell_theorem">theorem</a>) that if we were to estimate the alternative model</p>
<p><span class="math display">\[
\tilde{y}_i = \alpha + \beta_1^* \tilde{d}_i + \epsilon_i,
\]</span></p>
<p>where <span class="math inline">\(\tilde{y}_i\)</span> is the residual from regressing <span class="math inline">\(y\)</span> on <span class="math inline">\(x\)</span>, and <span class="math inline">\(\tilde{d}_i\)</span> the residual from regressing <span class="math inline">\(d\)</span> on <span class="math inline">\(x\)</span>, we would find that <span class="math inline">\(\beta_1^* = \beta_1\)</span>. That is, the two models are identical.</p>
<p>Second, to obtain <span class="math inline">\(\tilde{y}\)</span>, we first estimate</p>
<p><span class="math display">\[
y = \alpha + \delta x_i + u_i,
\]</span></p>
<p>and then calculate <span class="math inline">\(\tilde{y} = y - \delta x\)</span> (the calculation of <span class="math inline">\(\tilde{d}_i\)</span> works analogously). Given that this is a simple regression model, we know that <span class="math inline">\(\delta = \frac{cov(y, x)}{var(x)}\)</span> so that</p>
<p><span class="math display">\[
\tilde{y} = y - \frac{cov(y, x)}{var(x)}x.
\]</span></p>
<p>Finally, above in our discussion of CUPED we have seen that the CUPED-adjusted outcome metric <span class="math inline">\(\tilde{y}\)</span> is defined in exactly the same way. Hence, to evaluate an experiment with a CUPED-adjusted outcome, we would estimate the model:</p>
<p><span class="math display">\[
\tilde{y}_i = \alpha + \beta^* d_i + \epsilon_i^*,
\]</span></p>
<p>Notice that the only difference to model (2) is that we don’t adjust the treatment assignment – we use <span class="math inline">\(d_i\)</span> instead of <span class="math inline">\(\tilde{d}_i\)</span>. But if the treatment assignment is random, then <span class="math inline">\(cov(d, x) = 0\)</span> so that the adjustment has no effect and we have <span class="math inline">\(\tilde{d}_i = d_i\)</span>. Hence, the two approaches are the same.</p>
<p>In general, regression adjustment and CUPED are identical if two conditions hold: (1) the treatment indicator is independent of <span class="math inline">\(x\)</span>, and (2) we use a linear CUPED adjustment. In the context of experimentation, where treatment is random, and with the classical (linear) CUPED adjustment discussed above, this is always the case.</p>
<p>The reason why in practice we get a don’t get the exact same result is that the covariance of <span class="math inline">\(d\)</span> and <span class="math inline">\(x\)</span> is only approximately 0, hence providing very similar, but not identical results.</p>
</section>
<section id="is-cuped-did" class="level3" data-number="14.2.8">
<h3 data-number="14.2.8" class="anchored" data-anchor-id="is-cuped-did"><span class="header-section-number">14.2.8</span> Is CUPED DiD?</h3>
<ul>
<li>Is CUPED DiD? (based on Courthoud) – same if theta = 1</li>
</ul>
</section>
<section id="non-linear-extensions" class="level3" data-number="14.2.9">
<h3 data-number="14.2.9" class="anchored" data-anchor-id="non-linear-extensions"><span class="header-section-number">14.2.9</span> Non-linear extensions</h3>
</section>
<section id="blog-post-notes" class="level3" data-number="14.2.10">
<h3 data-number="14.2.10" class="anchored" data-anchor-id="blog-post-notes"><span class="header-section-number">14.2.10</span> Blog post notes</h3>
<p>CUPED is a re-invention of multiple linear regression. Evan Miller (<a href="https://www.evanmiller.org/you-cant-spell-cuped-without-frisch-waugh-lovell.html">here</a>) and Matteo Courthoud (<a href="https://towardsdatascience.com/understanding-cuped-a822523641af">here</a>) make similar points in their excellent posts on the topic, but – given my starting point – neither quite helped me fully understand what is going on. This post is my attempt to do that.</p>
<p>In particular, I think that to really understand the connection between multiple linear regression and CUPED, you have to understand the linear algebra of the Frisch-Waugh-Lowell theorem (FWL) rather than just knowing that that theorem says, and to understand that, you have to understand the concept of a projection.</p>
<p>###&nbsp;Useful resources</p>
<ul>
<li><p><a href="https://www.exp-platform.com/Documents/2013-02-CUPED-ImprovingSensitivityOfControlledExperiments.pdf">The original CUPED paper</a> – the original paper</p></li>
<li><p><a href="https://alexdeng.github.io/causal/sensitivity.html#vrreg">Variance reduction section of Deng’s causal inference book</a> – more in-depth discussion of some aspects of CUPED and its link to regression adjustment</p></li>
<li><p><a href="https://www.kdd.org/kdd2016/papers/files/adp0945-xieA.pdf">Improving the Sensitivity of Online Controlled Experiments: Case Studies at Netflix</a></p></li>
<li><p><a href="https://booking.ai/how-booking-com-increases-the-power-of-online-experiments-with-cuped-995d186fff1d">How Booking.com increases the power of online experiments with CUPED</a></p></li>
<li><p><a href="https://www.evanmiller.org/you-cant-spell-cuped-without-frisch-waugh-lovell.html">You can’t spell CUPED without Frisch-Waugh-Lovell</a> – good post exploring link to FWL theorem</p></li>
<li><p><a href="https://towardsdatascience.com/understanding-cuped-a822523641af">Understanding CUPED</a> – good post exploring link to multiple regression (also using FWL theorem) and DiD.</p></li>
<li><p><a href="https://bytepawn.com/reducing-variance-in-ab-testing-with-cuped.html#reducing-variance-in-ab-testing-with-cuped">Reducing variance in A/B testing with CUPED</a></p></li>
<li><p><a href="https://blog.statsig.com/cuped-on-statsig-d57f23122d0e">CUPED on Statsig</a></p></li>
</ul>
</section>
</section>
<section id="stratification" class="level2" data-number="14.3">
<h2 data-number="14.3" class="anchored" data-anchor-id="stratification"><span class="header-section-number">14.3</span> Stratification</h2>
<p>TODO</p>
<section id="useful-resources" class="level3" data-number="14.3.1">
<h3 data-number="14.3.1" class="anchored" data-anchor-id="useful-resources"><span class="header-section-number">14.3.1</span> Useful resources</h3>
<ul>
<li><p><a href="https://www.exp-platform.com/Documents/2013-02-CUPED-ImprovingSensitivityOfControlledExperiments.pdf">Deng et al.&nbsp;2013 – original CUPED paper</a> – the original paper</p></li>
<li><p><a href="https://bytepawn.com/five-ways-to-reduce-variance-in-ab-testing.html#five-ways-to-reduce-variance-in-ab-testing">Five ways to reduce variance in A/B testing</a></p></li>
</ul>
</section>
</section>
<section id="regression-adjustment" class="level2" data-number="14.4">
<h2 data-number="14.4" class="anchored" data-anchor-id="regression-adjustment"><span class="header-section-number">14.4</span> Regression adjustment</h2>
<p>Regression adjustment reduces variance by adding additional regressors to the regression model used to evaluate an experiment in order to reduce residual variance.</p>
<p><strong>How it works</strong></p>
<p>To evaluate an experiment where we have, for each unit <span class="math inline">\(i\)</span>, an outcome metric <span class="math inline">\(y_i\)</span> and a treatment assignment indicator <span class="math inline">\(d_i\)</span> we would estimate the following linear regression model using OLS:</p>
<p><span class="math display">\[
y_i = \alpha + \beta d_i + \epsilon_i,
\]</span></p>
<p>where <span class="math inline">\(\epsilon_i\)</span> is the error term, and where the estimate of <span class="math inline">\(\beta\)</span> is the estimate of our average treatment effect. If we have an additional variable, <span class="math inline">\(x_i\)</span>, that is correlated with <span class="math inline">\(y_i\)</span> but uncorrelated with <span class="math inline">\(d_i\)</span>, we can add that to the right hand side of our regression model and estimate:</p>
<p><span class="math display">\[
y_i = \alpha + \beta_1 d_i + \beta_2 x_i + \mu_i.
\]</span></p>
<p>If <span class="math inline">\(x\)</span> is uncorrelated with the treatment assignment then <span class="math inline">\(\beta = \beta_1\)</span>, so the average treatment effect estimate will remain unchanged, which is good. And if <span class="math inline">\(x\)</span> is correlated with <span class="math inline">\(y\)</span>, then the standard error of the average treatment effect estimate will again be lower, which increases power.</p>
<section id="useful-resources-1" class="level3" data-number="14.4.1">
<h3 data-number="14.4.1" class="anchored" data-anchor-id="useful-resources-1"><span class="header-section-number">14.4.1</span> Useful resources</h3>
<ul>
<li>Imbens &amp; Rubin, Causal Inference for Statistics, Social, and Biomedical Sciences, Chapter 7 <a href="https://www.cambridge.org/core/books/causal-inference-for-statistics-social-and-biomedical-sciences/71126BE90C58F1A431FE9B2DD07938AB">link</a></li>
</ul>
</section>
</section>
<section id="cupac" class="level2" data-number="14.5">
<h2 data-number="14.5" class="anchored" data-anchor-id="cupac"><span class="header-section-number">14.5</span> CUPAC</h2>
<ul>
<li><p>CUPED was designed by folks at Doordash <span class="citation" data-cites="tang2000control">(<a href="#ref-tang2000control" role="doc-biblioref">Tang et al. 2000</a>)</span> to reduce the duration of their switchback experiments, which – according to their paper – it did by about 25 percent.</p></li>
<li><p>CUPED can be extended to (make notation consistent with CUPED)</p></li>
</ul>
<p><span class="math display">\[
y' = y - \theta \bar{f(X)} + \theta E(f(X))
\]</span></p>
<ul>
<li><p>In above, it can be shown that optimal <span class="math inline">\(f(X) = E(Y|X)\)</span> (show this).</p></li>
<li><p>CUPED, which is effectively regression adjustment, uses best linear predictor.</p></li>
<li><p>CUPAC extends this to non-linear predictors, generating <span class="math inline">\(\hat{y} = g(X) = E(Y|X)\)</span>.</p></li>
</ul>
<section id="advantages" class="level3" data-number="14.5.1">
<h3 data-number="14.5.1" class="anchored" data-anchor-id="advantages"><span class="header-section-number">14.5.1</span> Advantages</h3>
<ul>
<li>Can be used for metrics that have no pre-experiment data (if you have variables that correlate with the metric and are unaffected by the treatment)</li>
</ul>
</section>
<section id="thoughts" class="level3" data-number="14.5.2">
<h3 data-number="14.5.2" class="anchored" data-anchor-id="thoughts"><span class="header-section-number">14.5.2</span> Thoughts</h3>
<ul>
<li><p>There are two approaches: predict the experiment-time outcome or predict the pre-experiment value.</p></li>
<li><p>If you do the former, then you need features that are unaffected by the treatment. This means that for reach metric and each experiment, you need to collect features that meet this requirement. This will be different for each metric and experiment because for many features, whether or not the feature is impacted by the treatment depends on the specific experiment (i.e.&nbsp;where in the funnel the feature is active). This could be solved by finding, for each metric of interest, a set of features that are always independent of the treatment (such as distance between restaurant and customer, or the type of browser used by a customer), but it’s not at all clear that finding a set of features with good predictive properties is possible for all our metrics. Hence, building this into a pipeline in an automated way would be an enormous endeavour, if it’s possible at all.</p></li>
<li><p>This approach is thus really only viable in a very specialised setting where you keep running the same type of experiment, and thus have to build and train the model manually and only once (this is how it’s being used for courier experiments).</p></li>
<li><p>To ensure that features really are independent of treatment condition, they actively monitor correlations for each running experiment.</p></li>
<li><p><span class="citation" data-cites="tang2000control">Tang et al. (<a href="#ref-tang2000control" role="doc-biblioref">2000</a>)</span> gives the example of reducing average daily delivery time, where a delivery-level covariate that is unaffected by treatment is distance between restaurant and customer.</p></li>
</ul>
</section>
<section id="useful-resources-2" class="level3" data-number="14.5.3">
<h3 data-number="14.5.3" class="anchored" data-anchor-id="useful-resources-2"><span class="header-section-number">14.5.3</span> Useful resources</h3>
<ul>
<li><a href="[file:///Users/fabian.gunzinger/Downloads/code_final_draft1.pdf](https://www.researchgate.net/publication/345698207_Control_Using_Predictions_as_Covariates_in_Switchback_Experiments)">Control Using Predictions as Covariates in Switchback Experiments</a></li>
</ul>
</section>
</section>
<section id="other-methods" class="level2" data-number="14.6">
<h2 data-number="14.6" class="anchored" data-anchor-id="other-methods"><span class="header-section-number">14.6</span> Other methods</h2>
<ul>
<li><a href="https://alexdeng.github.io/public/files/kdd2023-inexp.pdf">Variance Reduction Using In-Experiment Data: Efficient and Targeted Online Measurement for Sparse and Delayed Outcomes</a></li>
</ul>
</section>
<section id="useful-resources-3" class="level2" data-number="14.7">
<h2 data-number="14.7" class="anchored" data-anchor-id="useful-resources-3"><span class="header-section-number">14.7</span> Useful resources</h2>
<ul>
<li><p><a href="https://bytepawn.com/five-ways-to-reduce-variance-in-ab-testing.html#five-ways-to-reduce-variance-in-ab-testing">Five ways to reduce variance in A/B testing</a></p></li>
<li><p><a href="https://towardsdatascience.com/online-experiments-tricks-variance-reduction-291b6032dcd7">Online Experiments Tricks — Variance Reduction</a></p></li>
<li><p><a href="https://j-sephb-lt-n.github.io/exploring_statistics/cuped_cupac_and_other_variance_reduction_techniques.html">CUPED, CUPAC, and Other Ways to Reduce Variance in an Experiment</a></p></li>
<li><p><a href="https://towardsdatascience.com/dont-use-a-t-test-for-a-b-testing-e4d2ef7ab9b6">Don’t use a t-test for A/B testing</a></p></li>
<li><p><a href="https://towardsdatascience.com/variance-reduction-in-experiments-part-1-intuition-68b270a0df71">Variance Reduction in Experiments — Part 1: Intuition – see also part 2</a></p></li>
</ul>


<div id="refs" class="references csl-bib-body hanging-indent" role="list">
<div id="ref-tang2000control" class="csl-entry" role="listitem">
Tang, Yixin, Caixia Huang, David Kastelman, and Jared Bauman. 2000. <span>“Control Using Predictions as Covariates in Switchback Experiments.”</span>
</div>
</div>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../chapters/practical_issues.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Practical issues</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../chapters/network_experiments.html" class="pagination-link">
        <span class="nav-page-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Network experiments</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->



</body></html>